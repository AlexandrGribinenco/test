name: Daily health check
on:
  schedule:
    - cron: "0 6 * * *"  
  workflow_dispatch: {}  
jobs:
  check_and_notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Ping website
        id: ping
        run: |
          URL="https://alliedium.alliedtesting.com/"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 20 "$URL" || echo "000")
          echo "code=$CODE" >> $GITHUB_OUTPUT
          
      - name: Post OK message to Slack when 2xx
        if: startsWith(steps.ping.outputs.code, '2')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TEXT="✅ Alliedium is UP (HTTP ${{ steps.ping.outputs.code }}) — $(date -u +'%Y-%m-%d %H:%M UTC')"
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$TEXT\"}" "$SLACK_WEBHOOK_URL"
            
      - name: Post FAIL message to Slack when not 2xx
        if: "!startsWith(steps.ping.outputs.code, '2')"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          TEXT="❌ Alliedium health-check failed (HTTP ${{ steps.ping.outputs.code }}) — $(date -u +'%Y-%m-%d %H:%M UTC')"
          curl -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$TEXT\"}" "$SLACK_WEBHOOK_URL"
          curl -fsS -m 10 https://uptime.betterstack.com/api/v1/heartbeat/abc123xyz456 || true
          
      - name: Keep workflow alive
        if: github.event.schedule == '0 6 * * *'
        run: |
          if [ $(date +%d) == "01" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit --allow-empty -m "chore: keep workflow active [skip ci]"
            git push
          fi
